<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Leave Application Portal</title>
    <link rel="stylesheet" href="statics/css/staff_css2.css"></style>
    
</head>
<body>
    <header class="header">
        <h1>Leave Requestes</h1>
    </header>

    <nav class="sidebar">
        <div class="user-profile">
            <div class="profile-pic">üë§</div>
            <span>Username</span>
        </div>
        <ul class="menu-list">
            <li><a href="student_dash.html" >
                <span class="menu-icon">üè†</span> Dashboard</a></li>
            <li><a href="student_leave.html" >
                <span class="menu-icon">‚úçÔ∏è</span> Leave Applications
            </a></li>
            <li><a href="student_result.html">
                <span class="menu-icon">üìä</span> Check Result</a></li>
            <li><a href="login_student.html"><span class="menu-icon">üö™ </span> Logout</a></li>

        </ul>
    </nav>

    <div class="container">
        <div class="header-actions">
            <button class="stats-btn" onclick="openStatsModal()">Leave Statistics</button>
        </div>
        <table id="applicationTable">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <!-- Update the table body section -->
            <tbody>
                {% if leaves %}
                    {% for leave in leaves %}
                    <tr>
                        <td><img src="/static/placeholder.jpg" alt="Profile" class="profile-img"></td>
                        <td>{{ leave.name }}</td>
                        <td>{{ leave.studentId }}</td>
                        <td>{{ leave.fromDate }}</td>
                        <td>{{ leave.toDate }}</td>
                        <td>{{ leave.category }}</td>
                        <td>
                            <button class="view-btn" onclick="viewLeaveLetter('{{ leave.studentId }}')">View</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center;">No approved applications found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Modals -->
    <div id="remarksModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRemarkModal()">&times;</span>
            <h2>Enter Remarks</h2>
            <textarea id="remarkText" placeholder="Enter your remarks here..."></textarea>
            <button class="approve-btn" onclick="submitRemark()">Send</button>
        </div>
    </div>

    <div id="viewLetterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeViewLetterModal()">&times;</span>
            <div id="letterContent">
                <!-- Letter content will be inserted here -->
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeStatsModal()">&times;</span>
            <h2>Leave Statistics</h2>
            <div id="statsContent">
                <!-- Statistics content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let applications = [];
    
        // ‚úÖ Load approved applications when the page loads
        window.onload = async function () {
            await loadStudentApprovedApplications();
            setInterval(loadStudentApprovedApplications, 30000); // Refresh every 30 seconds
        };
    
        // ‚úÖ Fetch approved applications ONLY for the logged-in student
        async function loadStudentApprovedApplications() {
            try {
                const response = await fetch('/api/get_student_approved_applications'); // ‚úÖ Correct API
                if (!response.ok) throw new Error('Failed to fetch applications');
    
                applications = await response.json();
    
                console.log("üìå Fetched Student Approved Applications:", applications); // Debugging log
    
                populateTable();
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }
    
        // ‚úÖ Populate the table with ONLY the logged-in student's approved applications
        function populateTable() {
            const tableBody = document.querySelector("#applicationTable tbody");
            if (!tableBody) return;
    
            if (applications.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='7' style='text-align: center;'>No approved applications found</td></tr>";
                return;
            }
    
            tableBody.innerHTML = '';
            applications.forEach(app => {
                const row = `
                    <tr>
                        <td><img src="${app.photo || '/static/placeholder.jpg'}" alt="Profile" class="profile-img"></td>
                        <td>${app.name}</td>
                        <td>${app.studentId}</td>
                        <td>${app.fromDate}</td>
                        <td>${app.toDate}</td>
                        <td>${app.category}</td>
                        <td>
                            <button class="view-btn" onclick="viewLeaveLetter(${app.id})">View</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
    
        // ‚úÖ Show leave letter modal
        function viewLeaveLetter(id) {
            const app = applications.find(a => a.id === id);
            if (!app) return;
    
            const letterContent = `
                <div class="leave-letter">
                    <div class="student-info">
                        <img src="${app.photo || '/static/placeholder.jpg'}" alt="Profile" class="student-photo">
                        <div>
                            <h2>${app.name}</h2>
                            <p>Student ID: ${app.studentId}</p>
                            <p>Department: ${app.department}</p>
                            <p>Year: ${app.year}</p>
                        </div>
                    </div>
                    <h3>Application Details</h3>
                    <p><strong>Category:</strong> ${app.category}</p>
                    <p><strong>From Date:</strong> ${app.fromDate}</p>
                    <p><strong>To Date:</strong> ${app.toDate}</p>
                    <p><strong>Total Days:</strong> ${app.totalLeaveDays}</p>
                    <p><strong>Status:</strong> <span class="status-approved">Approved</span></p>
                    <p><strong>Reason:</strong> ${app.reason}</p>
                </div>
            `;
            document.getElementById('letterContent').innerHTML = letterContent;
            document.getElementById('viewLetterModal').style.display = 'block';
        }
    
        // ‚úÖ Close modal
        function closeViewLetterModal() {
            document.getElementById('viewLetterModal').style.display = 'none';
        }
    
        // ‚úÖ Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('viewLetterModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    </script>
    
            </body>
            </html>